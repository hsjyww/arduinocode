#include <Arduino.h>

const int tiltPin   = 2;   // SW-520D 입력(한쪽: D2, 다른쪽: GND)
const int buzzerPin = 8;   // 능동부저
const int ledPin    = 9;   // LED

// 시간 파라미터 (필요하면 늘려보세요)
const unsigned long DEBOUNCE_MS = 80;    // 채터링 억제(샘플 안정화)
const unsigned long ALARM_MS    = 800;   // 알람 유지 시간
const unsigned long REARM_MS    = 600;   // 기준자세 안정 유지 후 재무장

// 내부 상태
bool baseline;                 // 전원 켤 때의 기준 자세(HIGH/LOW)
bool lastRaw;                  // 마지막 생(raw) 읽은 값
bool stableReading;            // 디바운스 후 확정값
unsigned long lastFlipMs = 0;  // raw 값이 바뀐 시각
unsigned long stateStart = 0;  // 상태 시작 시각

enum Mode { ARMED, ALARM, WAIT_STABLE };
Mode mode = ARMED;

void setAlarm(bool on) {
  digitalWrite(buzzerPin, on ? HIGH : LOW);
  digitalWrite(ledPin,    on ? HIGH : LOW);
}

void setup() {
  pinMode(tiltPin, INPUT_PULLUP);  // 외부저항 없이 사용
  pinMode(buzzerPin, OUTPUT);
  pinMode(ledPin, OUTPUT);
  Serial.begin(9600);

  delay(200);                      // 전원/센서 안정화
  baseline = digitalRead(tiltPin); // 현재 자세를 기준으로 설정
  lastRaw = baseline;
  stableReading = baseline;
  setAlarm(false);

  Serial.print("Baseline=");
  Serial.println(baseline == HIGH ? "HIGH" : "LOW");
}

void loop() {
  // 1) 디바운스: raw가 바뀌면 타임스탬프만 갱신, DEBOUNCE_MS 지나면 확정
  bool raw = digitalRead(tiltPin);
  if (raw != lastRaw) {
    lastRaw = raw;
    lastFlipMs = millis();
  }
  if (millis() - lastFlipMs > DEBOUNCE_MS) {
    stableReading = raw;  // 충분히 안정됐을 때만 업데이트
  }

  switch (mode) {
    case ARMED:
      // 기준과 다르면 "기울림 이벤트"로 간주 → 한 번만 울리고 상태 전환
      if (stableReading != baseline) {
        setAlarm(true);
        stateStart = millis();
        mode = ALARM;
        Serial.println("EVENT: tilt detected (one-shot alarm)");
      }
      break;

    case ALARM:
      // 정해진 시간만 울리고 종료 → WAIT_STABLE로 넘어감
      if (millis() - stateStart >= ALARM_MS) {
        setAlarm(false);
        stateStart = millis();
        mode = WAIT_STABLE;
        Serial.println("INFO: alarm finished, waiting for stable baseline");
      }
      break;

    case WAIT_STABLE:
      // 기준자세로 돌아와 "연속 REARM_MS" 동안 유지되면 재무장
      if (stableReading == baseline) {
        if (millis() - stateStart >= REARM_MS) {
          mode = ARMED;
          Serial.println("INFO: re-armed");
        }
      } else {
        // 다시 흔들렸으면 안정 대기 시간을 리셋
        stateStart = millis();
      }
      break;
  }
}
