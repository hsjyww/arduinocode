#include <Arduino.h>

// 핀 설정
const int trigPin   = 9;   // HC-SR04 Trig
const int echoPin   = 10;  // HC-SR04 Echo
const int buzzerPin = 3;   // 부저

// 거리 임계값
const int CLOSE_TONE_CM = 3;   // 3cm 이하 → 연속음(삐————)
const int NEAR_CM       = 15;  // 근접 비프
const int MID_CM        = 25;  // 중간 비프
const int FAR_CM        = 40;  // 여유 비프
const int MAX_BEEP_CM   = 200; // 이 초과 → 무음

// 1회 측정
int readDistanceOnce() {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  unsigned long duration = pulseIn(echoPin, HIGH, 30000UL); // ~5m
  if (duration == 0) return -1;
  return (int)(duration * 0.0343 / 2.0); // μs → cm
}

// 7회 측정 → 유효값만 중앙값
int getStableDistance() {
  int vals[7], n = 0;
  for (int i = 0; i < 7; i++) {
    int d = readDistanceOnce();
    if (d > 0 && d < 400) vals[n++] = d;
    delay(10);
  }
  if (n == 0) return -1;
  for (int i = 1; i < n; i++) {
    int key = vals[i], j = i - 1;
    while (j >= 0 && vals[j] > key) { vals[j+1] = vals[j]; j--; }
    vals[j+1] = key;
  }
  return vals[n/2];
}

// 거리별 부저 제어
void beepByDistance(int cm) {
  if (cm < 0 || cm > MAX_BEEP_CM) { // 측정불가/너무 멀다 → 무음
    noTone(buzzerPin);
    delay(50);
    return;
  }

  // 2cm 이하 → 연속음
  if (cm <= CLOSE_TONE_CM) {
    tone(buzzerPin, 1000);  // 1kHz 계속 울림
    delay(50);              // CPU 숨 고르기
    return;                 // noTone() 호출하지 않음 → 지속
  }

  // 비프 간격 제어 (가까울수록 빨라짐)
  int onMs  = 80;
  int offMs = 0;

  if (cm <= NEAR_CM)      offMs = 120;
  else if (cm <= MID_CM)  offMs = 250;
  else if (cm <= FAR_CM)  offMs = 400;
  else {
    noTone(buzzerPin);     // FAR_CM 초과는 무음
    delay(50);
    return;
  }

  tone(buzzerPin, 1000);
  delay(onMs);
  noTone(buzzerPin);
  delay(offMs);
}

void setup() {
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(buzzerPin, OUTPUT);
  Serial.begin(9600);
}

void loop() {
  int distance = getStableDistance();

  if (distance >= 0) {
    Serial.print("거리 : ");
    Serial.print(distance);
    Serial.println(" cm");
  } else {
    Serial.println("거리 : 측정 불가");
  }

  beepByDistance(distance);
}
