#include <Arduino.h>
#include <Wire.h>
#include <RTClib.h>

RTC_DS3231 rtc;

const int buzzerPin = 8;   // 부저 +
const int ALARM_HOUR   = 7;  // 알람 시각(24시간제)
const int ALARM_MINUTE = 0;  // 알람 분
const int ALARM_WINDOW_SEC = 10; // 알람을 감지하는 초 범위(중복 방지용)
bool alarmLatched = false;

void ringAlarm(unsigned long ms)
{
  unsigned long start = millis();
  while (millis() - start < ms) {
    tone(buzzerPin, 1000);
    delay(300);
    noTone(buzzerPin);
    delay(120);
    tone(buzzerPin, 1500);
    delay(300);
    noTone(buzzerPin);
    delay(120);
  }
}

void setup()
{
  pinMode(buzzerPin, OUTPUT);
  Serial.begin(9600);
  if (!rtc.begin()) {
    Serial.println("RTC를 찾을 수 없습니다. 배선 확인!");
    while (1) { delay(10); }
  }

  if (rtc.lostPower()) {
    // 스케치 컴파일(업로드) 시간으로 1회 설정
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
    // 수동 설정 예시: 다음 줄 주석 해제 후 원하는 시각 입력
    // rtc.adjust(DateTime(2025, 9, 8, 6, 59, 50)); // YYYY,MM,DD,HH,MM,SS
  }

  // 필요 시 알람 시간을 시리얼로 확인
  Serial.print("Daily Alarm at ");
  Serial.print(ALARM_HOUR);
  Serial.print(":");
  Serial.println(ALARM_MINUTE);
}

void loop()
{
  DateTime now = rtc.now();

  // 현재 시간 출력
  static uint32_t lastPrint = 0;
  if (millis() - lastPrint > 1000) {
    lastPrint = millis();
    char buf[20];
    snprintf(buf, sizeof(buf), "%02d:%02d:%02d", now.hour(), now.minute(), now.second());
    Serial.println(buf);
  }

  // 알람 조건: 지정된 시/분이고, 초가 ALARM_WINDOW_SEC 이내 + 래치 미설정
  if (now.hour() == ALARM_HOUR && now.minute() == ALARM_MINUTE) {
    if (!alarmLatched && now.second() < ALARM_WINDOW_SEC) {
      Serial.println("ALARM RING!");
      ringAlarm(8000); // 8초 울림
      alarmLatched = true;
    }
  } else {
    // 분이 넘어가면 다음 날을 위해 래치 해제
    alarmLatched = false;
  }
}
